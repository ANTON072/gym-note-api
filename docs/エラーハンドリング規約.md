# エラーハンドリング規約

## 基本方針

- 一貫性のあるエラーレスポンス形式を維持
- クライアントが適切にエラーハンドリングできる情報を提供
- セキュリティを考慮し、内部情報の漏洩を防ぐ

## HTTP ステータスコード

### 成功レスポンス (2xx)

| ステータスコード | 用途                         | 使用場面                  |
| ---------------- | ---------------------------- | ------------------------- |
| 200 OK           | リクエスト成功               | GET, PUT, PATCH の成功時  |
| 201 Created      | リソース作成成功             | POST でリソース作成成功時 |
| 204 No Content   | 成功（レスポンスボディなし） | DELETE の成功時           |

### クライアントエラー (4xx)

| ステータスコード         | 用途                 | 使用場面                         |
| ------------------------ | -------------------- | -------------------------------- |
| 400 Bad Request          | 不正なリクエスト     | リクエスト形式が不正な場合       |
| 401 Unauthorized         | 認証エラー           | 認証トークンが無効・期限切れ     |
| 403 Forbidden            | アクセス権限なし     | 他ユーザーのリソースへのアクセス |
| 404 Not Found            | リソースが存在しない | 指定 ID のリソースが見つからない |
| 422 Unprocessable Entity | バリデーションエラー | モデルのバリデーション失敗       |

### サーバーエラー (5xx)

| ステータスコード          | 用途               | 使用場面               |
| ------------------------- | ------------------ | ---------------------- |
| 500 Internal Server Error | サーバー内部エラー | 予期しないエラー発生時 |
| 503 Service Unavailable   | サービス利用不可   | メンテナンス中など     |

## エラーレスポンス形式

### 基本形式

```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "エラーメッセージ",
    "details": [] // オプション
  }
}
```

### エラーコード一覧

| エラーコード          | 説明                   | HTTP ステータス |
| --------------------- | ---------------------- | --------------- |
| INVALID_REQUEST       | リクエスト形式が不正   | 400             |
| AUTHENTICATION_FAILED | 認証失敗               | 401             |
| TOKEN_EXPIRED         | トークン期限切れ       | 401             |
| ACCESS_DENIED         | アクセス権限なし       | 403             |
| RESOURCE_NOT_FOUND    | リソースが見つからない | 404             |
| VALIDATION_ERROR      | バリデーションエラー   | 422             |
| INTERNAL_ERROR        | サーバー内部エラー     | 500             |

## 実装例

### ApplicationController での共通実装

```ruby
class ApplicationController < ActionController::API
  # 共通のエラーハンドリング
  rescue_from ActiveRecord::RecordNotFound, with: :render_not_found
  rescue_from ActiveRecord::RecordInvalid, with: :render_validation_error
  rescue_from ActionController::ParameterMissing, with: :render_bad_request

  private

  def render_error(code:, message:, status:, details: nil)
    error = {
      error: {
        code: code,
        message: message
      }
    }
    error[:error][:details] = details if details.present?
    render json: error, status: status
  end

  def render_not_found(exception)
    render_error(
      code: 'RESOURCE_NOT_FOUND',
      message: 'リソースが見つかりません',
      status: :not_found
    )
  end

  def render_validation_error(exception)
    render_error(
      code: 'VALIDATION_ERROR',
      message: '入力値が不正です',
      status: :unprocessable_entity,
      details: format_validation_errors(exception.record.errors)
    )
  end

  def render_bad_request(exception)
    render_error(
      code: 'INVALID_REQUEST',
      message: 'リクエストが不正です',
      status: :bad_request
    )
  end

  def format_validation_errors(errors)
    errors.map do |error|
      {
        field: error.attribute.to_s,
        message: error.message
      }
    end
  end
end
```

### 認証エラーの実装

```ruby
module Authenticatable
  extend ActiveSupport::Concern

  included do
    before_action :authenticate_user!
  end

  private

  def authenticate_user!
    token = request.headers['Authorization']&.split(' ')&.last

    if token.nil?
      render_error(
        code: 'AUTHENTICATION_FAILED',
        message: '認証トークンが必要です',
        status: :unauthorized
      )
      return
    end

    begin
      payload = Firebase::AuthService.verify_id_token(token, ENV['FIREBASE_PROJECT_ID'])
      @current_user = User.find_by!(firebase_uid: payload['sub'])
    rescue JWT::ExpiredSignature
      render_error(
        code: 'TOKEN_EXPIRED',
        message: 'トークンの有効期限が切れています',
        status: :unauthorized
      )
    rescue JWT::VerificationError, ActiveRecord::RecordNotFound
      render_error(
        code: 'AUTHENTICATION_FAILED',
        message: '認証に失敗しました',
        status: :unauthorized
      )
    end
  end
end
```

### コントローラーでの使用例

```ruby
class WorkoutsController < ApplicationController
  def create
    @workout = current_user.workouts.build(workout_params)

    if @workout.save
      render :show, status: :created
    else
      # ApplicationControllerのrender_errorを使用
      render_error(
        code: 'VALIDATION_ERROR',
        message: 'ワークアウトの作成に失敗しました',
        status: :unprocessable_entity,
        details: format_validation_errors(@workout.errors)
      )
    end
  end

  def show
    # find!を使用することで、見つからない場合は自動的に404エラー
    @workout = current_user.workouts.find(params[:id])
  end

  def destroy
    workout = current_user.workouts.find(params[:id])

    if workout.destroy
      head :no_content
    else
      render_error(
        code: 'INTERNAL_ERROR',
        message: '削除に失敗しました',
        status: :internal_server_error
      )
    end
  end
end
```

## レスポンス例

### 認証エラー (401)

```json
{
  "error": {
    "code": "AUTHENTICATION_FAILED",
    "message": "認証に失敗しました"
  }
}
```

### バリデーションエラー (422)

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "入力値が不正です",
    "details": [
      {
        "field": "weight",
        "message": "重量は正の整数である必要があります"
      },
      {
        "field": "performed_start_at",
        "message": "開始日時は必須です"
      }
    ]
  }
}
```

### リソース不存在 (404)

```json
{
  "error": {
    "code": "RESOURCE_NOT_FOUND",
    "message": "リソースが見つかりません"
  }
}
```

## テスト時の考慮事項

```ruby
class WorkoutsControllerTest < ActionDispatch::IntegrationTest
  test "should return 404 when workout not found" do
    sign_in_as(users(:one))

    get workout_url(999999)
    assert_response :not_found

    json = JSON.parse(response.body)
    assert_equal 'RESOURCE_NOT_FOUND', json['error']['code']
  end

  test "should return 422 with validation errors" do
    sign_in_as(users(:one))

    post workouts_url, params: { workout: { performed_start_at: nil } }
    assert_response :unprocessable_entity

    json = JSON.parse(response.body)
    assert_equal 'VALIDATION_ERROR', json['error']['code']
    assert json['error']['details'].present?
  end
end
```

## セキュリティ考慮事項

1. **内部情報の非公開**

   - スタックトレースを含めない
   - データベースのカラム名を直接露出しない
   - システムの内部構造を推測されるような情報を含めない

2. **適切なログ記録**

   - エラーの詳細はサーバーログに記録
   - クライアントには必要最小限の情報のみ返す

3. **レート制限**
   - 認証エラーが続く場合はレート制限を適用（今後の実装課題）

## 日本語化

エラーメッセージは日本語で返すため、以下の設定を使用：

```yaml
# config/locales/ja.yml
ja:
  activerecord:
    errors:
      models:
        workout:
          attributes:
            performed_start_at:
              blank: "開始日時は必須です"
            user:
              required: "ユーザーは必須です"
        set:
          attributes:
            weight:
              greater_than: "重量は0より大きい値を入力してください"
```
