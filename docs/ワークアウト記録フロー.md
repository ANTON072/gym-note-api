# ワークアウト記録フロー

## 概要

ユーザーがジムでのトレーニングを記録する際の基本的なフローを説明します。

## シーケンス図

```mermaid
sequenceDiagram
    participant U as ユーザー（アプリ）
    participant A as API
    participant DB as データベース

    Note over U,DB: ワークアウト開始
    U->>A: POST /api/v1/workouts<br/>{ started_at: "2025-01-11T10:00:00" }
    A->>DB: Workoutレコード作成
    DB-->>A: workout_id: 123
    A-->>U: 201 Created<br/>{ id: 123, started_at: "...", ended_at: null }

    Note over U,DB: エクササイズ追加（例：ベンチプレス）
    U->>A: POST /api/v1/workouts/123/exercises<br/>{ exercise_id: 1, order_index: 1 }
    A->>DB: WorkoutExerciseレコード作成
    DB-->>A: workout_exercise_id: 456
    A-->>U: 201 Created<br/>{ id: 456, exercise: {...}, sets: [] }

    Note over U,DB: セット1を追加
    U->>A: POST /api/v1/workout_exercises/456/sets<br/>{ weight: 60, reps: 10 }
    A->>DB: StrengthSetレコード作成（set_number自動採番）
    DB-->>A: 作成成功
    A-->>U: 201 Created<br/>{ id: 789, set_number: 1, weight: 60, reps: 10 }

    Note over U,DB: セット2を追加
    U->>A: POST /api/v1/workout_exercises/456/sets<br/>{ weight: 70, reps: 8 }
    A->>DB: StrengthSetレコード作成（set_number自動採番）
    DB-->>A: 作成成功
    A-->>U: 201 Created<br/>{ id: 790, set_number: 2, weight: 70, reps: 8 }

    Note over U,DB: 追加エクササイズ（例：スクワット）
    U->>A: POST /api/v1/workouts/123/exercises<br/>{ exercise_id: 2, order_index: 2 }
    A->>DB: WorkoutExerciseレコード作成
    DB-->>A: workout_exercise_id: 457
    A-->>U: 201 Created<br/>{ id: 457, exercise: "スクワット", sets: [] }

    Note over U,DB: スクワットのセット1を追加
    U->>A: POST /api/v1/workout_exercises/457/sets<br/>{ weight: 80, reps: 12 }
    A->>DB: StrengthSetレコード作成（set_number自動採番）
    DB-->>A: 作成成功
    A-->>U: 201 Created<br/>{ id: 791, set_number: 1, weight: 80, reps: 12 }

    Note over U,DB: 有酸素エクササイズ（例：トレッドミル）
    U->>A: POST /api/v1/workouts/123/exercises<br/>{ exercise_id: 10, order_index: 3 }
    A->>DB: WorkoutExerciseレコード作成
    DB-->>A: workout_exercise_id: 458
    A-->>U: 201 Created<br/>{ id: 458, exercise: "トレッドミル", sets: [] }

    Note over U,DB: トレッドミルのセット1を追加
    U->>A: POST /api/v1/workout_exercises/458/sets<br/>{ duration_seconds: 1800, distance: 6.5 }
    A->>DB: CardioSetレコード作成（set_number自動採番）
    DB-->>A: 作成成功
    A-->>U: 201 Created<br/>{ id: 792, set_number: 1, duration_seconds: 1800, distance: 6.5 }

    Note over U,DB: ワークアウト終了
    U->>A: PUT /api/v1/workouts/123<br/>{ ended_at: "2025-01-11T11:30:00" }
    A->>DB: Workoutレコード更新
    DB-->>A: 更新成功
    A-->>U: 200 OK<br/>{ id: 123, started_at: "...", ended_at: "..." }
```

## 詳細フロー

### 1. ワークアウト開始

```json
POST /api/v1/workouts
{
  "started_at": "2025-01-11T10:00:00Z"
}
```

レスポンス:
```json
{
  "id": 123,
  "started_at": "2025-01-11T10:00:00Z",
  "ended_at": null,
  "note": null
}
```

### 2. エクササイズを追加

```json
POST /api/v1/workouts/123/exercises
{
  "exercise_id": 1,
  "order_index": 1
}
```

レスポンス:
```json
{
  "id": 456,
  "exercise": {
    "id": 1,
    "name": "ベンチプレス",
    "body_part": "chest",
    "laterality": "bilateral"
  },
  "order_index": 1,
  "sets": []
}
```

### 3. セットを追加

筋トレセットの場合:
```json
POST /api/v1/workout_exercises/456/sets
{
  "weight": 60,
  "reps": 10,
  "bilateral": false
}
```

レスポンス:
```json
{
  "id": 789,
  "set_number": 1,
  "weight": 60,
  "reps": 10,
  "bilateral": false
}
```

有酸素セットの場合:
```json
POST /api/v1/workout_exercises/456/sets
{
  "duration_seconds": 1200,
  "distance": 5.0,
  "calories": 250
}
```

レスポンス:
```json
{
  "id": 790,
  "set_number": 1,
  "duration_seconds": 1200,
  "distance": 5.0,
  "calories": 250
}
```

### 4. ワークアウト終了

```json
PUT /api/v1/workouts/123
{
  "ended_at": "2025-01-11T11:30:00Z",
  "note": "今日は調子が良かった"
}
```

## 注意事項

- ワークアウトは開始時刻のみで作成可能（終了時刻は後から更新）
- エクササイズ追加とセット追加は別々のAPIコール
- セットは1つずつ追加（ユーザーがボタンを押すたびに追加）
- set_numberはAPI側で自動採番（該当エクササイズ内で連番）
- 筋トレと有酸素運動でセットの構造が異なる（body_partがcardioかどうかで判定）
- order_indexでワークアウト内のエクササイズの順序を管理