# テスト指針

## 基本方針

このプロジェクトでは、効率的な開発を重視し、以下のテスト戦略を採用します。

## テスト対象

### ✅ 実装するテスト

#### 1. モデルテスト（必須）
- **対象**: すべてのActiveRecordモデル
- **範囲**: 
  - バリデーション
  - 関連付け（アソシエーション）
  - カスタムメソッド
  - ビジネスロジック
- **理由**: データの整合性とビジネスルールの保証

**例:**
```ruby
# test/models/user_test.rb
test "firebase_uidの必須バリデーション"
test "emailの一意性バリデーション"
test "workoutsとの関連付け"
```

#### 2. 重要なビジネスロジックの単体テスト
- **対象**: 複雑な計算やデータ変換を行うメソッド
- **例**: 
  - 総負荷量計算
  - 統計情報の集計
  - データの変換処理

### ❌ 実装しないテスト

#### 1. コントローラーテスト
- **理由**: HTTPテストで代替
- **代替手段**: `api.http`ファイルでの手動テスト

#### 2. 統合テスト（基本的に不要）
- **理由**: 開発効率を優先
- **例外**: 本当に重要なエンドポイントのみ実装を検討

#### 3. フィーチャーテスト/システムテスト
- **理由**: APIサーバーのため不要

## HTTPテストの実施方法

### api.httpファイルの活用
```http
### ユーザー作成
POST http://localhost:3000/api/users
Content-Type: application/json

{
  "user": {
    "firebase_uid": "test_uid_123",
    "email": "test@example.com",
    "name": "テストユーザー"
  }
}

### ワークアウト作成
POST http://localhost:3000/api/workouts
Content-Type: application/json
Authorization: Bearer {{firebase_token}}

{
  "workout": {
    "performed_start_at": "2025-01-10T10:00:00Z"
  }
}
```

### レスポンス確認項目
- ステータスコード
- レスポンスボディの構造
- エラーハンドリング
- 認証・認可の動作

## テストデータの管理

### 共通ヘルパーメソッドの使用
```ruby
# test/test_helper.rb に定義済み
def create_test_user
def create_test_workout(user:)
def create_bilateral_exercise
# etc...
```

### フィクスチャの使用方針
- **基本的に使用しない**
- **理由**: 動的なデータ生成を優先（firebase_uid、emailの一意性確保）

## テスト実行

### モデルテストの実行
```bash
# 全モデルテスト
rails test test/models/

# 特定のモデル
rails test test/models/user_test.rb

# 特定のテストメソッド
rails test test/models/user_test.rb::test_user_creation
```

### コード品質チェック
```bash
# RuboCop実行
bundle exec rubocop

# 自動修正
bundle exec rubocop -a
```

## 例外的にテストを追加する場合

以下の場合は追加のテストを検討します：

1. **セキュリティに関わる処理**
   - 認証・認可ロジック
   - データアクセス制御

2. **データ損失リスクの高い処理**
   - 一括削除機能
   - データ移行処理

3. **複雑なAPI仕様**
   - 複数のモデルにまたがる処理
   - トランザクション処理

## 継続的な改善

### テスト追加の判断基準
- **バグ発生時**: 該当箇所のテストを追加
- **リファクタリング時**: 安全性確保のためテスト追加を検討
- **本番リリース前**: 重要機能の統合テスト追加を検討

### ドキュメントの更新
このテスト指針は開発の進行に応じて見直し、必要に応じて更新します。

## まとめ

- **モデルテスト**: 確実に実装
- **HTTPテスト**: `api.http`で手動実施
- **効率重視**: 過度なテストは避ける
- **実用性優先**: 実際の動作確認を重視

この方針により、開発速度を保ちながら品質を確保します。