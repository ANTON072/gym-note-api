# テスト実装のベストプラクティス

## 概要

このドキュメントは、認証ミドルウェア実装時に遭遇した課題と解決策をまとめ、今後のテスト実装の参考とするためのものです。

## 使用技術

- **テストフレームワーク**: Minitest (Rails標準)
- **モックライブラリ**: Mocha (test_helper.rbで`require "mocha/minitest"`済み)

## 失敗パターンと解決策

### 1. RSpecライクなメソッド名を使用してしまった

**失敗例**:
```ruby
allow_any_instance_of(TestController).to receive(:firebase_project_id).and_return(@project_id)
```

**解決策**: Mochaの正しい構文を使用
```ruby
@controller.stubs(:firebase_project_id).returns(@project_id)
Firebase::AuthService.stubs(:verify_id_token).with(token, project_id).returns(payload)
Firebase::AuthService.stubs(:verify_id_token).raises(JWT::VerificationError.new("Invalid token"))
```

### 2. ActionController::TestCaseでのリクエスト設定の問題

**失敗例**:
```ruby
class AuthenticatableTest < ActionController::TestCase
  # @request が nil になってしまう
```

**解決策**: ActiveSupport::TestCaseを使用し、独自のモックリクエストを作成
```ruby
class AuthenticatableTest < ActiveSupport::TestCase
  class TestController < ActionController::API
    include Authenticatable
    attr_accessor :request

    def initialize
      super
      self.request = MockRequest.new
    end
  end

  class MockRequest
    attr_accessor :headers

    def initialize
      @headers = {}
    end
  end
end
```

### 3. テスト環境でのActionController::TestRequest.create の引数エラー

**失敗例**:
```ruby
@request = ActionController::TestRequest.create  # 引数が必要
```

**解決策**: カスタムモッククラスを使用
```ruby
class MockRequest
  attr_accessor :headers
  def initialize
    @headers = {}
  end
end
```

## 推奨テストパターン

### Concern (ミックスイン) のテスト

```ruby
require "test_helper"

class AuthenticatableTest < ActiveSupport::TestCase
  class TestController < ActionController::API
    include Authenticatable
    attr_accessor :request

    def initialize
      super
      self.request = MockRequest.new
    end
  end

  class MockRequest
    attr_accessor :headers
    def initialize
      @headers = {}
    end
  end

  setup do
    @controller = TestController.new
    ENV["FIREBASE_PROJECT_ID"] = "test-project"
  end

  test "メソッドの動作を検証する" do
    # テストの実装
  end
end
```

### モックとスタブの使い方

```ruby
# 戻り値を設定する場合
SomeService.stubs(:method_name).returns(expected_value)

# 例外を発生させる場合
SomeService.stubs(:method_name).raises(SomeException.new("message"))

# 引数の検証も含める場合
SomeService.stubs(:method_name).with(expected_arg).returns(expected_value)

# メソッド呼び出しの検証
@controller.expects(:render).with(json: { error: "message" }, status: :unauthorized)
```

### フィクスチャの活用

テストデータは `test/fixtures/` に配置し、YAMLで定義する：

```yaml
# test/fixtures/users.yml
one:
  firebase_uid: "firebase_uid_123"
  email: "test@example.com"
  name: "Test User"
  image_url: "https://example.com/avatar.jpg"
```

テスト内での利用：
```ruby
test "既存ユーザーでのテスト" do
  user = users(:one)  # フィクスチャから取得
  # テスト処理
end
```

## 注意事項

1. **Minitestの構文を使用する**: RSpecライクな構文は使用できない
2. **環境変数の設定**: テスト時に必要な環境変数は `setup` で設定する
3. **モックライブラリの確認**: `test/test_helper.rb` でMochaが読み込まれていることを確認
4. **継承クラスの選択**: 用途に応じて適切なテストクラスを継承する
   - `ActiveSupport::TestCase`: ユニットテスト
   - `ActionDispatch::IntegrationTest`: 統合テスト
   - `ActionController::TestCase`: コントローラーテスト（推奨されない）

## TDDワークフロー

1. **テスト作成**: 期待される動作を先にテストで定義
2. **テスト実行**: 失敗することを確認（Red）
3. **実装**: テストをパスする最小限の実装（Green）
4. **リファクタリング**: コードの品質向上（Refactor）
5. **コミット**: テストと実装をセットでコミット

## 参考情報

- [Minitest公式ドキュメント](https://github.com/minitest/minitest)
- [Mocha公式ドキュメント](https://mocha.jamesmead.org/)
- [Rails Testing Guide](https://guides.rubyonrails.org/testing.html)
