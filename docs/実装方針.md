# 実装方針

## 基本原則: Skinny Controller, Fat Model

### コントローラー（Skinny）

- アクションは極力短く、5 行以内を目指す
- ビジネスロジックは書かない
- モデルとビューの仲介役に徹する
- 主な責務：
  - パラメータの受け取り
  - モデルのメソッド呼び出し
  - レスポンスの返却

### モデル（Fat）

- ビジネスロジックを集約
- データベースクエリはスコープやクラスメソッドに
- 計算処理や集計処理もモデルに
- バリデーションルールを明確に定義

## 実装例

### 悪い例（ロジックがコントローラーに）

```ruby
class WorkoutsController < ApplicationController
  def create
    workout = current_user.workouts.new(workout_params)

    # 総負荷量の計算がコントローラーに...
    total_volume = 0
    params[:exercises].each do |exercise_params|
      exercise = workout.workout_exercises.build(exercise_params)
      exercise_volume = 0
      exercise_params[:sets].each do |set_params|
        weight = set_params[:weight]
        reps = set_params[:reps]
        exercise_volume += weight * reps
      end
      exercise.total_volume = exercise_volume
      total_volume += exercise_volume
    end
    workout.total_volume = total_volume

    if workout.save
      render json: workout
    else
      render json: { errors: workout.errors }, status: :unprocessable_entity
    end
  end
end
```

### 良い例（ロジックをモデルに）

```ruby
# app/controllers/workouts_controller.rb
class WorkoutsController < ApplicationController
  def create
    workout = current_user.workouts.build(workout_params)

    if workout.save
      render json: workout
    else
      render json: { errors: workout.errors }, status: :unprocessable_entity
    end
  end

  private

  def workout_params
    params.require(:workout).permit(
      :performed_start_at,
      :performed_end_at,
      :memo,
      exercises_attributes: [:exercise_id, sets_attributes: [:type, :weight, :reps, :duration_seconds, :calories]]
    )
  end
end

# app/models/workout.rb
class Workout < ApplicationRecord
  belongs_to :user
  has_many :workout_exercises, dependent: :destroy
  has_many :exercises, through: :workout_exercises

  accepts_nested_attributes_for :workout_exercises

  before_save :calculate_total_volume

  private

  def calculate_total_volume
    self.total_volume = workout_exercises.sum(&:total_volume)
  end
end

# app/models/workout_exercise.rb
class WorkoutExercise < ApplicationRecord
  belongs_to :workout
  belongs_to :exercise
  has_many :sets, dependent: :destroy

  accepts_nested_attributes_for :sets

  before_save :calculate_total_volume

  private

  def calculate_total_volume
    self.total_volume = sets.sum(&:volume)
  end
end

# app/models/set.rb
class Set < ApplicationRecord
  belongs_to :workout_exercise

  def volume
    raise NotImplementedError
  end
end

# app/models/strength_set.rb
class StrengthSet < Set
  validates :weight, :reps, presence: true

  def volume
    if workout_exercise.exercise.is_dumbbell?
      weight * 2 * total_reps
    else
      weight * total_reps
    end
  end

  private

  def total_reps
    if workout_exercise.exercise.is_unilateral?
      (left_reps || 0) + (right_reps || 0)
    else
      reps || 0
    end
  end
end

# app/models/cardio_set.rb
class CardioSet < Set
  validates :duration_seconds, presence: true

  def volume
    0 # 有酸素運動は負荷量に含めない
  end
end
```

## その他の基本方針

### 1. シンプルなバリデーション

```ruby
class Exercise < ApplicationRecord
  validates :name, presence: true, uniqueness: true
  validates :is_dumbbell, :is_unilateral, :is_bodyweight, :is_cardio, inclusion: { in: [true, false] }
end
```

### 2. わかりやすいスコープ

```ruby
class Workout < ApplicationRecord
  scope :recent, -> { order(performed_start_at: :desc) }
  scope :between, ->(start_date, end_date) { where(performed_start_at: start_date..end_date) }
  scope :today, -> { where(performed_start_at: Time.current.beginning_of_day..Time.current.end_of_day) }
end
```

### 3. シンプルなクラスメソッド

```ruby
class Weight < ApplicationRecord
  def self.record_for_date(user, date, weight_value)
    weight = user.weights.find_or_initialize_by(recorded_at: date.beginning_of_day)
    weight.weight = weight_value
    weight.save
    weight
  end
end
```

## 避けるべきこと

- Service Object（初級者には複雑）
  - **例外**: 外部 API 連携（Firebase 認証、決済 API 等）は Service Object が適切
  - **例外**: 複数のモデルにまたがる複雑なトランザクション処理
  - 現在のプロジェクトでは `Firebase::AuthService` のみ使用
- 過度なメタプログラミング
- 複雑なコールバックチェーン
- concerns の過度な使用

## 推奨事項

- ActiveRecord の基本機能を活用
- accepts_nested_attributes でネストしたデータを扱う
- シンプルなバリデーションとコールバック
- わかりやすい命名
- 1 メソッド 1 責務

## 利用する Gem

### 推奨

- **jbuilder**: JSON レスポンスの統一的な管理

  - コントローラーをシンプルに保てる（5 行以内の実現）
  - レスポンス形式が明確で一貫性がある
  - 部分テンプレートで再利用可能
  - Rails 標準的で学習リソースが豊富

  設定：

  ```ruby
  # Gemfile（コメントアウトを外す）
  gem "jbuilder"
  ```

  使用例：

  ```ruby
  # コントローラー（シンプル！）
  def index
    @workouts = current_user.workouts.recent.page(params[:page])
  end

  def show
    @workout = current_user.workouts.find(params[:id])
  end

  # app/views/workouts/index.json.jbuilder
  json.workouts @workouts do |workout|
    json.partial! 'workout', workout: workout
  end

  json.meta do
    json.current_page @workouts.current_page
    json.total_pages @workouts.total_pages
    json.total_count @workouts.total_count
  end

  # app/views/workouts/_workout.json.jbuilder（再利用可能）
  json.extract! workout, :id, :performed_start_at, :performed_end_at, :memo, :total_volume
  json.exercises workout.workout_exercises do |we|
    json.partial! 'workout_exercise', workout_exercise: we
  end
  ```

- **kaminari**: ページネーション（シンプルで使いやすい）

  設定：

  ```ruby
  # Gemfile
  gem "kaminari"
  ```

  使用例：

  ```ruby
  # コントローラーで
  @workouts = current_user.workouts.page(params[:page]).per(10)
  ```

- **annotate**: モデルにスキーマ情報を自動でコメント追加

  ```ruby
  # == Schema Information
  #
  # Table name: workouts
  #
  #  id                 :bigint           not null, primary key
  #  user_id            :bigint           not null
  #  performed_start_at :datetime         not null
  #  performed_end_at   :datetime
  #  total_volume       :integer          default(0)
  #  memo               :text
  #  created_at         :datetime         not null
  #  updated_at         :datetime         not null
  #
  class Workout < ApplicationRecord
    # モデルのコード
  end
  ```

  設定：

  ```ruby
  # Gemfile
  gem 'annotate', group: :development

  # 実行コマンド
  bundle exec annotate --models

  # 自動実行設定（マイグレーション後に自動更新）
  # lib/tasks/auto_annotate_models.rake が生成される
  bundle exec rails g annotate:install
  ```

### 開発環境推奨

- **bullet**: N+1問題の検出（開発環境のみ）

  設定：
  ```ruby
  # Gemfile
  group :development do
    gem "bullet"
  end
  ```

  初期設定：
  ```ruby
  # config/environments/development.rb
  config.after_initialize do
    Bullet.enable = true
    Bullet.alert = true
    Bullet.bullet_logger = true
    Bullet.console = true
    Bullet.rails_logger = true
    Bullet.add_footer = true
  end
  ```

  検出例：
  ```ruby
  # N+1が発生するコード
  @workouts = current_user.workouts.recent
  # ビューで @workouts.each { |w| w.exercises } すると警告

  # 解決方法
  @workouts = current_user.workouts.includes(:exercises).recent
  ```
