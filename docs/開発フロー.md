# 開発フロー

## 新機能実装の標準フロー

### 1. ブランチ作成

```bash
# feature/機能名 の形式でブランチを作成
git checkout -b feature/workout_api
```

### 2. マイグレーション作成

```bash
# モデルとマイグレーションを同時に作成
rails g model Workout user:references performed_start_at:datetime performed_end_at:datetime total_volume:integer memo:text

# マイグレーションのみ作成する場合
rails g migration AddIndexToWorkouts

# マイグレーション実行
rails db:migrate

# ロールバック（必要な場合）
rails db:rollback
```

### 3. モデル実装（TDD）

#### 3-1. テスト作成

```ruby
# test/models/workout_test.rb
class WorkoutTest < ActiveSupport::TestCase
  test "should calculate total volume" do
    workout = workouts(:one)
    assert_equal 120000, workout.total_volume
  end
end
```

#### 3-2. テスト実行（失敗を確認）

```bash
rails test test/models/workout_test.rb
```

#### 3-3. モデル実装

```ruby
# app/models/workout.rb
class Workout < ApplicationRecord
  # 実装
end
```

#### 3-4. テスト実行（成功を確認）

```bash
rails test test/models/workout_test.rb
```

### 4. コントローラー実装（TDD）

#### 4-1. 統合テスト作成

```ruby
# test/controllers/workouts_controller_test.rb
class WorkoutsControllerTest < ActionDispatch::IntegrationTest
  setup do
    @user = users(:one)
    sign_in_as(@user)
  end

  test "should create workout" do
    assert_difference('Workout.count') do
      post workouts_url, params: { workout: valid_params }
    end
    assert_response :created
  end
end
```

#### 4-2. ルーティング追加

```ruby
# config/routes.rb
Rails.application.routes.draw do
  resources :workouts
end
```

#### 4-3. コントローラー実装

```ruby
# app/controllers/workouts_controller.rb
class WorkoutsController < ApplicationController
  # Skinny Controller
  def create
    @workout = current_user.workouts.build(workout_params)
    if @workout.save
      render :show, status: :created
    else
      render json: { errors: @workout.errors }, status: :unprocessable_entity
    end
  end
end
```

#### 4-4. jbuilder ビュー作成

```ruby
# app/views/workouts/show.json.jbuilder
json.extract! @workout, :id, :performed_start_at, :performed_end_at
```

### 5. 品質チェック

#### 5-1. 全テスト実行

```bash
rails test
```

#### 5-2. Rubocop 実行

```bash
bundle exec rubocop

# 自動修正
bundle exec rubocop -A
```

#### 5-3. Annotate 実行

```bash
bundle exec annotaterb models
```

### 6. コミット・プッシュ

```bash
# 変更確認
git status
git diff

# ステージング
git add .

# コミット（Lefthookが自動チェック実行）
git commit -m "ワークアウトAPIを実装"

# プッシュ
git push -u origin feature/workout_api
```

### 7. プルリクエスト作成

```bash
# GitHub CLIを使用
gh pr create --title "ワークアウトAPIの実装" --body "実装内容の説明"
```

## よく使うコマンド集

### データベース関連

```bash
# データベース作成
rails db:create

# マイグレーション状態確認
rails db:migrate:status

# スキーマ確認
cat db/schema.rb

# シード実行
rails db:seed

# データベースリセット（開発環境のみ）
rails db:reset
```

### テスト関連

```bash
# 全テスト実行
rails test

# 特定ファイルのテスト
rails test test/models/workout_test.rb

# 特定のテストメソッド実行
rails test test/models/workout_test.rb:10

# 詳細出力
rails test -v
```

### サーバー関連

```bash
# Rails サーバー起動（Dev Container内）
rails server -b 0.0.0.0

# ログ確認
tail -f log/development.log

# Rails コンソール
rails console
```

### 開発用タスク

```bash
# ルーティング確認
rails routes | grep workout

# モデル関連確認
rails runner "puts Workout.column_names"

# タスク一覧
rails -T
```

## 開発時の注意事項

### Gemfile 更新時

Dev Container 環境では、Gemfile 更新後に必ず以下を実行：

```bash
# Dev Container内のターミナルで実行
bundle install
```

### マイグレーション作成時の命名規則

```bash
# テーブル作成
rails g migration CreateWorkouts

# カラム追加
rails g migration AddMemoToWorkouts memo:text

# インデックス追加
rails g migration AddIndexToWorkoutsOnUserId

# カラム削除
rails g migration RemoveMemoFromWorkouts memo:text
```

### テストデータの準備

```yaml
# test/fixtures/users.yml
one:
  firebase_uid: test-uid-123
  email: test@example.com

# test/fixtures/workouts.yml
one:
  user: one
  performed_start_at: 2024-01-15 10:00:00
```

### API テストの実行

```bash
# HTTPieを使用（インストール済みの場合）
http POST localhost:3000/workouts Authorization:"Bearer TOKEN" < request.json

# curlを使用
curl -X POST http://localhost:3000/workouts \
  -H "Authorization: Bearer TOKEN" \
  -H "Content-Type: application/json" \
  -d @request.json
```
