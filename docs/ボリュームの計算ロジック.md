# ボリュームの計算ロジック

- 筋トレにおける「ボリューム」とは、一般的に「重量 x 回数 x セット数」で計算されるトレーニングの総量である。
- 単位はキログラムだが、小数点を使いたくないのでデータ上はグラムで扱う。利用する際にキログラムに変換する。
- 1workout単位でのボリューム量をworkoutモデルのtotal_volumeに記録する。
- 1種目ごとのボリューム量をworkout_exerciseモデルのtotal_volumeに記録する。
- 1セットごとのボリューム量をworkout_setモデルのvolumeに記録する（パラメータがまだない）。
- workout_exerciseのボリューム量は set.volume * setの数で算出する。とするとDBのパラメータとしては不要か？
- workoutsのボリューム量は workout_exersice.total_volume * workout_exersiceの数で算出する。となるとここもDBのパラメータとしては不要か？
- 最終的にセットのvolumeだけあれば計算が可能か？パフォーマンスと合わせて検討したい。
- 画面表示としては1workoutのボリューム量を表示できればOK。1種目ごとのボリュームは表示しない。
- ボリューム量をchartで表示するなども検討したい。
- 有酸素運動の場合はボリュームは計算しない。
- 筋力トレーニングのボリューム計算：
  - bilateral（両側）の場合: `weight * reps`
  - unilateral（片側）の場合: `weight * reps * 2`（記録された重量は片方なので2倍）
- lateralityの概念は残すが、セット記録はrepsのみでシンプルな設計とする。

## 実装方針

### 採用する設計
- **WorkoutSet**: `volume` カラムを追加（セット単位のボリュームを保存）
- **WorkoutExercise**: `total_volume` カラムは削除し、SQL集計で動的に取得
- **Workout**: `total_volume` カラムも削除し、SQL集計で動的に取得

### 理由
- データの正規化とパフォーマンスのバランスが良い
- セット単位のボリュームがあれば、SQL集計で種目・ワークアウト単位の集計が可能
- チャート表示時もインデックスを適切に設定すれば十分なパフォーマンスを確保できる

## 実装計画

### 1. テストの作成
- `test/models/strength_set_test.rb` に volume 自動計算のテストを追加
  - bilateral種目の場合: `weight * reps`
  - unilateral種目の場合: `weight * reps * 2`
- `test/models/cardio_set_test.rb` に volume が常に0であることのテストを追加
- `test/models/workout_exercise_test.rb` に total_volume 集計メソッドのテストを追加
  - StrengthSetのvolumeの合計が正しく計算されること
  - CardioSetは集計に含まれないこと
- `test/models/workout_test.rb` に total_volume 集計メソッドのテストを追加
  - 複数のWorkoutExerciseのvolumeの合計が正しく計算されること
  - 有酸素運動のみの場合は0になること

### 2. マイグレーションファイルの新規追加
```ruby
class AddVolumeToWorkoutSets < ActiveRecord::Migration[8.0]
  def change
    add_column :workout_sets, :volume, :integer, default: 0, null: false
    add_index :workout_sets, :volume
  end
end

class RemoveTotalVolumeFromWorkoutRelatedTables < ActiveRecord::Migration[8.0]
  def change
    remove_column :workout_exercises, :total_volume, :integer
    remove_column :workouts, :total_volume, :integer
  end
end
```

### 3. モデルの機能変更
- `StrengthSet` モデル
  - 既存の `volume` メソッドを削除
  - `before_save :calculate_volume` コールバックを追加
  - `calculate_volume` プライベートメソッドで計算ロジックを実装
- `CardioSet` モデル
  - volume は常に0（デフォルト値）なので特別な処理は不要
- `WorkoutExercise` モデル
  - `total_volume` カラムを削除
  - 動的な集計メソッドを追加: `workout_sets.where(type: 'StrengthSet').sum(:volume)`
- `Workout` モデル
  - `total_volume` カラムを削除
  - 動的な集計メソッドを追加

### 4. テストの実行
- すべてのテストがパスすることを確認
- 特に volume 計算の正確性を重点的にテスト
