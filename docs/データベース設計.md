# データベース設計

## ER 図

```mermaid
erDiagram
    users ||--o{ workouts : "has many"
    workouts ||--o{ workout_exercises : "has many"
    workout_exercises }o--|| exercises : "belongs to"
    workout_exercises ||--o{ sets : "has many"

    users {
        bigint id PK
        string firebase_uid UK "Firebase認証UID"
        string email
        string name
        datetime created_at
        datetime updated_at
    }

    exercises {
        bigint id PK
        string name UK "種目名"
        integer exercise_type "運動タイプ"
        integer laterality "実施形態"
        text memo "メモ"
        datetime created_at
        datetime updated_at
    }

    workouts {
        bigint id PK
        bigint user_id FK
        datetime performed_start_at "開始日時"
        datetime performed_end_at "終了日時"
        integer total_volume "総負荷量(g)"
        text memo "メモ"
        datetime created_at
        datetime updated_at
    }

    workout_exercises {
        bigint id PK
        bigint workout_id FK
        bigint exercise_id FK
        integer order "表示順"
        integer total_volume "種目別総負荷量(g)"
        datetime created_at
        datetime updated_at
    }

    sets {
        bigint id PK
        bigint workout_exercise_id FK
        string type "STI(StrengthSet/CardioSet)"
        integer weight "重量(g)"
        integer reps "レップ数"
        integer left_reps "左レップ数"
        integer right_reps "右レップ数"
        integer duration_seconds "実施時間(秒)"
        integer calories "消費カロリー(kcal)"
        integer order "セット順"
        datetime created_at
        datetime updated_at
    }
```

## テーブル定義詳細

### users（ユーザー）

| カラム名     | 型           | NULL | デフォルト        | 説明              |
| ------------ | ------------ | ---- | ----------------- | ----------------- |
| id           | bigint       | NO   | AUTO_INCREMENT    | 主キー            |
| firebase_uid | varchar(128) | NO   | -                 | Firebase 認証 UID |
| email        | varchar(255) | NO   | -                 | メールアドレス    |
| name         | varchar(255) | YES  | NULL              | 表示名            |
| created_at   | datetime     | NO   | CURRENT_TIMESTAMP | 作成日時          |
| updated_at   | datetime     | NO   | CURRENT_TIMESTAMP | 更新日時          |

### exercises（種目マスタ）

| カラム名       | 型           | NULL | デフォルト        | 説明                          |
| -------------- | ------------ | ---- | ----------------- | ----------------------------- |
| id             | bigint       | NO   | AUTO_INCREMENT    | 主キー                        |
| name           | varchar(255) | NO   | -                 | 種目名                        |
| exercise_type  | integer      | NO   | -                 | 運動タイプ（enum: 0-1）       |
| laterality     | integer      | YES  | NULL              | 実施形態（enum: 0-1）         |
| memo           | text         | YES  | NULL              | メモ                          |
| created_at     | datetime     | NO   | CURRENT_TIMESTAMP | 作成日時                      |
| updated_at     | datetime     | NO   | CURRENT_TIMESTAMP | 更新日時                      |

#### exercise_type の値

| 値 | 名称     | 説明           |
|----|---------|---------------|
| 0  | strength| 筋力トレーニング |
| 1  | cardio  | 有酸素運動     |

#### laterality の値

| 値 | 名称       | 説明           |
|----|-----------|---------------|
| 0  | bilateral | 両側同時実施   |
| 1  | unilateral| 片側ずつ実施   |

※ 有酸素運動（cardio）の場合は NULL

### workouts（ワークアウト）

| カラム名           | 型       | NULL | デフォルト        | 説明             |
| ------------------ | -------- | ---- | ----------------- | ---------------- |
| id                 | bigint   | NO   | AUTO_INCREMENT    | 主キー           |
| user_id            | bigint   | NO   | -                 | ユーザー ID      |
| performed_start_at | datetime | NO   | -                 | 開始日時         |
| performed_end_at   | datetime | YES  | NULL              | 終了日時         |
| total_volume       | integer  | NO   | 0                 | 総負荷量(グラム) |
| memo               | text     | YES  | NULL              | メモ             |
| created_at         | datetime | NO   | CURRENT_TIMESTAMP | 作成日時         |
| updated_at         | datetime | NO   | CURRENT_TIMESTAMP | 更新日時         |

### workout_exercises（ワークアウト内の種目）

| カラム名     | 型       | NULL | デフォルト        | 説明                       |
| ------------ | -------- | ---- | ----------------- | -------------------------- |
| id           | bigint   | NO   | AUTO_INCREMENT    | 主キー                     |
| workout_id   | bigint   | NO   | -                 | ワークアウト ID            |
| exercise_id  | bigint   | NO   | -                 | 種目 ID                    |
| order        | integer  | NO   | -                 | 表示順                     |
| total_volume | integer  | NO   | 0                 | この種目の総負荷量(グラム) |
| created_at   | datetime | NO   | CURRENT_TIMESTAMP | 作成日時                   |
| updated_at   | datetime | NO   | CURRENT_TIMESTAMP | 更新日時                   |

### sets（セット）

| カラム名            | 型           | NULL | デフォルト        | 説明                              |
| ------------------- | ------------ | ---- | ----------------- | --------------------------------- |
| id                  | bigint       | NO   | AUTO_INCREMENT    | 主キー                            |
| workout_exercise_id | bigint       | NO   | -                 | WorkoutExercise ID                |
| type                | varchar(255) | NO   | -                 | STI 識別子(StrengthSet/CardioSet) |
| weight              | integer      | YES  | NULL              | 重量(グラム) ※StrengthSet 用      |
| reps                | integer      | YES  | NULL              | レップ数 ※StrengthSet 用          |
| left_reps           | integer      | YES  | NULL              | 左レップ数 ※StrengthSet 用        |
| right_reps          | integer      | YES  | NULL              | 右レップ数 ※StrengthSet 用        |
| duration_seconds    | integer      | YES  | NULL              | 実施時間(秒) ※CardioSet 用        |
| calories            | integer      | YES  | NULL              | 消費カロリー(kcal) ※CardioSet 用  |
| order               | integer      | NO   | -                 | セット順                          |
| created_at          | datetime     | NO   | CURRENT_TIMESTAMP | 作成日時                          |
| updated_at          | datetime     | NO   | CURRENT_TIMESTAMP | 更新日時                          |

## インデックス設計

### users

- `index_users_on_firebase_uid` (firebase_uid) UNIQUE
- `index_users_on_email` (email) UNIQUE

### exercises

- `index_exercises_on_name` (name) UNIQUE

### workouts

- `index_workouts_on_user_id` (user_id)
- `index_workouts_on_user_id_and_performed_start_at` (user_id, performed_start_at)

### workout_exercises

- `index_workout_exercises_on_workout_id` (workout_id)
- `index_workout_exercises_on_exercise_id` (exercise_id)
- `index_workout_exercises_on_workout_id_and_order` (workout_id, order) UNIQUE

### sets

- `index_sets_on_workout_exercise_id` (workout_exercise_id)
- `index_sets_on_type` (type)
- `index_sets_on_workout_exercise_id_and_order` (workout_exercise_id, order) UNIQUE

## 外部キー制約

- workouts.user_id → users.id (CASCADE DELETE)
- workout_exercises.workout_id → workouts.id (CASCADE DELETE)
- workout_exercises.exercise_id → exercises.id (RESTRICT)
- sets.workout_exercise_id → workout_exercises.id (CASCADE DELETE)

## データ型の選択理由

### integer 型の使用

- **重量**: グラム単位で保存することで小数点計算を回避
- **カロリー**: kcal 単位で整数として保存
- **時間**: 秒単位で保存

### datetime 型

- すべての日時は UTC で保存
- ActiveRecord が自動的にタイムゾーン変換を処理

### STI（単一テーブル継承）

- sets テーブルで type カラムを使用
- StrengthSet と CardioSet で異なる振る舞いを実装

## パフォーマンス考慮事項

### 事前計算フィールド

- workouts.total_volume: ワークアウト全体の総負荷量を事前計算
- workout_exercises.total_volume: 種目別の総負荷量を事前計算

### N+1 問題対策

- 適切な includes を使用してクエリを最適化
- jbuilder での部分テンプレート使用時は特に注意

## マイグレーション実行順序

1. users
2. exercises
3. workouts
4. workout_exercises
5. sets

この順序で外部キー制約のエラーを回避できます。
